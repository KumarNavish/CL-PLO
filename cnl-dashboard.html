<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Remote Training Status Dashboard</title>
  <style>
    :root {
      --bg: #f2f8fc;
      --ink: #112538;
      --muted: #516a80;
      --card: #ffffff;
      --line: #d4e1eb;
      --ok: #13652b;
      --warn: #936200;
      --bad: #a71f32;
    }
    body {
      margin: 0;
      background: linear-gradient(160deg, #eaf3fa 0%, #f8fbff 62%);
      color: var(--ink);
      font-family: "Avenir Next", "Segoe UI", sans-serif;
    }
    .wrap {
      max-width: 1160px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 30px;
      letter-spacing: 0.3px;
    }
    .muted {
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 14px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }
    select {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--ink);
      min-width: 260px;
      font-size: 14px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      border: 1px solid transparent;
    }
    .status-ok {
      color: var(--ok);
      background: #e6f5ea;
      border-color: #bfe3c8;
    }
    .status-error {
      color: var(--bad);
      background: #fdecef;
      border-color: #f7c9d2;
    }
    .status-warn {
      color: var(--warn);
      background: #fff4dc;
      border-color: #f0d8a7;
    }
    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      margin: 12px 0 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(23, 50, 76, 0.07);
    }
    .card .label {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .card .value {
      margin-top: 5px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 14px;
      line-height: 1.35;
    }
    .section {
      margin-bottom: 16px;
    }
    .section h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid var(--line);
      padding: 7px 8px;
      text-align: left;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #e8f1f8;
      font-size: 12px;
      letter-spacing: 0.3px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .status-running { color: var(--warn); font-weight: 700; }
    .status-done { color: var(--ok); font-weight: 700; }
    .status-error { color: var(--bad); font-weight: 700; }
    .status-pending { color: #607689; font-weight: 700; }
    pre {
      margin: 0;
      padding: 12px;
      border-radius: 10px;
      background: #0f172a;
      color: #d9e4f0;
      font-size: 12px;
      line-height: 1.35;
      overflow: auto;
      max-height: 330px;
    }
    a {
      color: #005cc5;
      text-decoration: none;
      font-weight: 700;
    }
    .appendix-shell {
      position: relative;
      overflow: hidden;
      border: 1px solid #c9d7e5;
      border-radius: 16px;
      background:
        radial-gradient(circle at 6% 12%, rgba(209, 233, 251, 0.75), rgba(209, 233, 251, 0) 45%),
        radial-gradient(circle at 92% 0%, rgba(255, 238, 210, 0.72), rgba(255, 238, 210, 0) 40%),
        linear-gradient(155deg, #ffffff 0%, #f6fbff 52%, #fffaf3 100%);
      box-shadow: 0 18px 34px rgba(16, 50, 81, 0.13);
      padding: 18px;
    }
    .appendix-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(110deg, rgba(255, 255, 255, 0.28), rgba(255, 255, 255, 0));
    }
    .appendix-kicker {
      position: relative;
      z-index: 1;
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: #114061;
      background: rgba(213, 232, 247, 0.78);
      border: 1px solid rgba(108, 151, 184, 0.3);
      font-weight: 700;
    }
    .appendix-title {
      position: relative;
      z-index: 1;
      margin: 10px 0 2px;
      font-family: "Iowan Old Style", "Palatino Linotype", "Book Antiqua", serif;
      font-size: 30px;
      line-height: 1.1;
      letter-spacing: 0.2px;
      color: #0f2f48;
    }
    .appendix-subtitle {
      position: relative;
      z-index: 1;
      margin: 0 0 16px;
      color: #36566f;
      font-size: 14px;
      line-height: 1.45;
    }
    .appendix-grid {
      position: relative;
      z-index: 1;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .appendix-panel {
      border-radius: 12px;
      border: 1px solid #d4e2ee;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(1px);
      padding: 12px;
    }
    .appendix-panel h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #0f3049;
      letter-spacing: 0.2px;
    }
    .appendix-panel p {
      margin: 0 0 8px;
      color: #24465f;
      font-size: 13px;
      line-height: 1.45;
    }
    .appendix-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 7px;
    }
    .appendix-list li {
      position: relative;
      padding-left: 16px;
      color: #1f415a;
      font-size: 13px;
      line-height: 1.42;
    }
    .appendix-list li::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0.56em;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #2d7fb5;
      box-shadow: 0 0 0 3px rgba(45, 127, 181, 0.12);
    }
    .appendix-panel.tone-good {
      border-color: #c7e3d1;
      background: linear-gradient(150deg, rgba(241, 252, 245, 0.95), rgba(255, 255, 255, 0.84));
    }
    .appendix-panel.tone-good h3 {
      color: #0f4a2b;
    }
    .appendix-panel.tone-good .appendix-list li::before {
      background: #2f9553;
      box-shadow: 0 0 0 3px rgba(47, 149, 83, 0.13);
    }
    .appendix-panel.tone-caution {
      border-color: #ead8bf;
      background: linear-gradient(150deg, rgba(255, 249, 237, 0.95), rgba(255, 255, 255, 0.84));
    }
    .appendix-panel.tone-caution h3 {
      color: #6b4f14;
    }
    .appendix-panel.tone-caution .appendix-list li::before {
      background: #b98721;
      box-shadow: 0 0 0 3px rgba(185, 135, 33, 0.15);
    }
    .paper-wrap {
      background: #fff;
      border: 1px solid #cfd7de;
      border-radius: 10px;
      padding: 10px 12px 12px;
      overflow-x: auto;
    }
    .paper-caption {
      margin: 0 0 8px;
      font-family: "Times New Roman", Georgia, serif;
      font-size: 18px;
      line-height: 1.15;
      color: #111;
    }
    .paper-caption .paper-title {
      font-weight: 700;
    }
    .paper-table {
      width: 100%;
      border-collapse: collapse;
      border: none;
      border-radius: 0;
      font-family: "Times New Roman", Georgia, serif;
      background: #fff;
    }
    .paper-table thead tr:first-child th {
      border-top: 2px solid #333;
    }
    .paper-table thead th {
      background: #fff;
      border-bottom: 1px solid #555;
      color: #111;
      font-size: 13px;
      font-variant: small-caps;
      letter-spacing: 0.2px;
      padding: 5px 6px 3px;
      text-align: center;
      white-space: nowrap;
    }
    .paper-table td {
      border-bottom: 1px solid #666;
      color: #111;
      font-size: 14px;
      line-height: 1.02;
      padding: 4px 7px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    .paper-table tbody tr:last-child td {
      border-bottom: 2px solid #333;
    }
    .paper-table .left {
      text-align: left;
    }
    .paper-table .italic {
      font-style: italic;
    }
    .paper-table .sub {
      display: block;
      font-size: 0.92em;
      margin-top: 1px;
    }
    .paper-sep td {
      border-top: 1px solid #555;
    }
    @media (max-width: 800px) {
      .wrap {
        padding: 16px;
      }
      h1 {
        font-size: 24px;
      }
      .paper-caption {
        font-size: 16px;
      }
      .paper-table thead th {
        font-size: 17px;
      }
      .paper-table td {
        font-size: 16px;
      }
      .appendix-title {
        font-size: 24px;
      }
      .appendix-shell {
        padding: 14px;
      }
      .appendix-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Remote Training Status Dashboard</h1>
    <p class="muted" id="meta">Loading dashboard snapshot...</p>

    <div class="toolbar">
      <label for="projectSelect"><strong>Project</strong></label>
      <select id="projectSelect"></select>
      <span id="projectStatus" class="badge status-ok">-</span>
    </div>

    <div id="projectError" class="section"></div>
    <div id="cards" class="grid"></div>
    <div id="links" class="section"></div>
    <div id="tables"></div>
    <div id="appendix" class="section"></div>
    <div id="texts"></div>
  </div>

  <script>
    const JSON_PATH = 'data/run_status.json';
    let payload = null;

    function esc(value) {
      return String(value ?? "").replace(/[&<>]/g, (ch) => {
        if (ch === "&") return "&amp;";
        if (ch === "<") return "&lt;";
        return "&gt;";
      });
    }

    function datasetLabel(dataset) {
      const names = {
        mmlu: "MMLU",
        medqa: "MedQA",
        arc_c: "ARC-C",
        csqa: "CSQA",
      };
      return names[dataset] || dataset || "";
    }

    function splitMainSub(rawValue) {
      const text = String(rawValue ?? "").trim();
      const m = text.match(/^(.+?)\s*\(([^)]*)\)$/);
      if (!m) {
        return { main: text, sub: "" };
      }
      return { main: m[1].trim(), sub: `(${m[2].trim()})` };
    }

    function renderMainSubCell(rawValue) {
      const parts = splitMainSub(rawValue);
      if (!parts.sub) {
        return esc(parts.main);
      }
      return `${esc(parts.main)}<span class="sub">${esc(parts.sub)}</span>`;
    }

    function paperCaption(table) {
      const title = table.title || "Table";
      const caption = table.caption || "";
      if (!caption) {
        return `<p class="paper-caption"><span class="paper-title">${esc(title)}.</span></p>`;
      }
      const prefix = `${title}:`;
      let text = caption;
      if (text.startsWith(prefix)) {
        text = text.slice(prefix.length).trim();
      }
      return `<p class="paper-caption"><span class="paper-title">${esc(prefix)}</span> ${esc(text)}</p>`;
    }

    function renderPaperTable1(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      const row = rows[0] || {};

      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">MODEL</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>DISSIM</th><th>SIM</th>`;
      }
      html += `</tr></thead><tbody><tr>`;
      html += `<td class="left italic">${esc(row.model || table.model || "")}</td>`;
      for (const ds of datasets) {
        html += `<td>${renderMainSubCell(row[`${ds}_dissimilar`])}</td>`;
        html += `<td>${renderMainSubCell(row[`${ds}_similar`])}</td>`;
      }
      html += `</tr></tbody></table></div>`;
      return html;
    }

    function renderPaperTable2(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      const byMetric = {};
      for (const row of rows) {
        byMetric[String(row.metric || "").toUpperCase()] = row;
      }

      const model = table.model || "";
      const prop = byMetric.PROP || {};
      const grad = byMetric.GRAD || {};
      const total = byMetric.TOTAL || {};

      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">MODEL</th>`;
      html += `<th class="left" rowspan="2">METRIC</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>COLL</th><th>CONF</th>`;
      }
      html += `</tr></thead><tbody>`;

      html += `<tr>`;
      html += `<td class="left italic" rowspan="3">${esc(model)}</td>`;
      html += `<td class="left">PROP</td>`;
      for (const ds of datasets) {
        html += `<td>${esc(prop[`${ds}_coll`] || "")}</td>`;
        html += `<td>${esc(prop[`${ds}_conf`] || "")}</td>`;
      }
      html += `</tr>`;

      html += `<tr>`;
      html += `<td class="left">GRAD</td>`;
      for (const ds of datasets) {
        html += `<td>${esc(grad[`${ds}_coll`] || "")}</td>`;
        html += `<td>${esc(grad[`${ds}_conf`] || "")}</td>`;
      }
      html += `</tr>`;

      html += `<tr>`;
      html += `<td class="left">TOTAL</td>`;
      for (const ds of datasets) {
        html += `<td colspan="2">${esc(total[`${ds}_total`] || "")}</td>`;
      }
      html += `</tr>`;

      html += `</tbody></table></div>`;
      return html;
    }

    function renderPaperTable3(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      const orderedRows = [];
      const seen = new Set();
      for (const method of ["FT", "CNL"]) {
        const idx = rows.findIndex((row) => String(row.method || "").toUpperCase() === method);
        if (idx >= 0) {
          orderedRows.push(rows[idx]);
          seen.add(idx);
        }
      }
      rows.forEach((row, idx) => {
        if (!seen.has(idx)) orderedRows.push(row);
      });

      const model = table.model || ((orderedRows[0] || {}).model || "");
      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">MODEL</th>`;
      html += `<th class="left" rowspan="2">METHOD</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>LEARNED</th><th>FORGOT</th>`;
      }
      html += `</tr></thead><tbody>`;

      orderedRows.forEach((row, idx) => {
        const sepClass = idx > 0 ? " paper-sep" : "";
        html += `<tr class="${sepClass.trim()}">`;
        if (idx === 0) {
          html += `<td class="left italic" rowspan="${orderedRows.length}">${esc(model)}</td>`;
        }
        html += `<td class="left">${esc(row.method || "")}</td>`;
        for (const ds of datasets) {
          html += `<td>${renderMainSubCell(row[`${ds}_learned`])}</td>`;
          html += `<td>${renderMainSubCell(row[`${ds}_forgot`])}</td>`;
        }
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      return html;
    }

    function renderPaperValue(rawValue) {
      const text = String(rawValue ?? "");
      if (text.trim().toUpperCase() === "PENDING") {
        return `<span class="status-pending">PENDING</span>`;
      }
      if (text.includes("(") && text.includes("%")) {
        return renderMainSubCell(text);
      }
      return esc(text);
    }

    function renderPaperTable4(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">OPTIMIZER</th>`;
      html += `<th class="left" rowspan="2">METHOD</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>LEARNED</th><th>FORGOT</th>`;
      }
      html += `</tr></thead><tbody>`;

      const groupSizes = {};
      for (const row of rows) {
        const key = String(row.optimizer || "");
        groupSizes[key] = (groupSizes[key] || 0) + 1;
      }

      let prevOpt = null;
      for (let i = 0; i < rows.length; i += 1) {
        const row = rows[i] || {};
        const opt = String(row.optimizer || "");
        const isNewGroup = i === 0 || opt !== prevOpt;
        const sepClass = isNewGroup && i > 0 ? " paper-sep" : "";
        html += `<tr class="${sepClass.trim()}">`;
        if (isNewGroup) {
          html += `<td class="left" rowspan="${groupSizes[opt] || 1}">${esc(opt)}</td>`;
        }
        html += `<td class="left">${esc(row.method || "")}</td>`;
        for (const ds of datasets) {
          html += `<td>${renderPaperValue(row[`${ds}_learned`])}</td>`;
          html += `<td>${renderPaperValue(row[`${ds}_forgot`])}</td>`;
        }
        html += `</tr>`;
        prevOpt = opt;
      }

      html += `</tbody></table></div>`;
      return html;
    }

    function renderPaperTable(table) {
      if (table.paper_table === "table1") {
        return renderPaperTable1(table);
      }
      if (table.paper_table === "table2") {
        return renderPaperTable2(table);
      }
      if (table.paper_table === "table3") {
        return renderPaperTable3(table);
      }
      if (table.paper_table === "table4") {
        return renderPaperTable4(table);
      }
      return renderTable(table);
    }

    function renderTable(table) {
      const cols = table.columns || [];
      const rows = table.rows || [];
      let html = `<div class="section"><h2>${esc(table.title || "Table")}</h2>`;
      html += "<table><tr>";
      for (const c of cols) {
        html += `<th>${esc(c.label || c.key || "")}</th>`;
      }
      html += "</tr>";
      for (const row of rows) {
        html += "<tr>";
        for (const c of cols) {
          const key = c.key || "";
          const value = row[key] ?? "";
          const cls = key === "status" ? `status-${String(value).toLowerCase()}` : "";
          html += `<td class="${esc(cls)}">${esc(value)}</td>`;
        }
        html += "</tr>";
      }
      html += "</table></div>";
      return html;
    }

    function normalizeHeading(line) {
      let title = String(line || "").trim();
      title = title.replace(/^[0-9]+\)\s*/, "");
      title = title.replace(/:$/, "");
      return title;
    }

    function panelTone(title) {
      const t = String(title || "").toLowerCase();
      if (t.includes("can safely conclude")) {
        return "tone-good";
      }
      if (t.includes("cannot claim")) {
        return "tone-caution";
      }
      return "";
    }

    function parseAppendix(content) {
      const lines = String(content || "").split(/\r?\n/);
      const sections = [];
      const intro = [];
      let current = null;

      for (const raw of lines) {
        const line = raw.trim();
        if (!line) {
          continue;
        }
        if (line.toLowerCase().startsWith("quick read")) {
          intro.push(line.replace(/:$/, ""));
          continue;
        }

        const isHeading = (/^[0-9]+\)\s+/.test(line) || (line.endsWith(":") && !line.startsWith("- ")));
        if (isHeading) {
          current = { title: normalizeHeading(line), bullets: [], paragraphs: [] };
          sections.push(current);
          continue;
        }

        if (line.startsWith("- ")) {
          if (!current) {
            current = { title: "Summary", bullets: [], paragraphs: [] };
            sections.push(current);
          }
          current.bullets.push(line.slice(2).trim());
          continue;
        }

        if (!current) {
          intro.push(line);
        } else {
          current.paragraphs.push(line);
        }
      }

      return { intro, sections };
    }

    function renderBeautifulAppendix(content) {
      const parsed = parseAppendix(content);
      let html = `<div class="appendix-shell">`;
      html += `<span class="appendix-kicker">Interpretation Layer</span>`;
      html += `<h2 class="appendix-title">Paper Comparison Appendix</h2>`;
      const subtitle = parsed.intro.length > 0 ? parsed.intro.join(" ") : "Simple explanation of what these results mean.";
      html += `<p class="appendix-subtitle">${esc(subtitle)}</p>`;
      html += `<div class="appendix-grid">`;

      for (const section of parsed.sections) {
        const tone = panelTone(section.title);
        html += `<section class="appendix-panel ${esc(tone)}">`;
        html += `<h3>${esc(section.title)}</h3>`;
        for (const para of section.paragraphs || []) {
          html += `<p>${esc(para)}</p>`;
        }
        if ((section.bullets || []).length > 0) {
          html += `<ul class="appendix-list">`;
          for (const item of section.bullets) {
            html += `<li>${esc(item)}</li>`;
          }
          html += `</ul>`;
        }
        html += `</section>`;
      }

      html += `</div></div>`;
      return html;
    }

    function renderProject(project) {
      const statusEl = document.getElementById("projectStatus");
      const status = String(project.status || "unknown").toLowerCase();
      const badgeTone = status === "error" ? "error" : (status === "stale" ? "warn" : "ok");
      statusEl.textContent = status;
      statusEl.className = `badge status-${badgeTone}`;

      const errEl = document.getElementById("projectError");
      if (status === "error") {
        errEl.innerHTML = `<div class="card"><strong>Collection Error</strong><div class="value">${esc(project.error || "unknown")}</div></div>`;
      } else {
        errEl.innerHTML = "";
      }

      const cards = project.cards || [];
      document.getElementById("cards").innerHTML = cards.map((card) => `
        <div class="card">
          <div class="label">${esc(card.label || "")}</div>
          <div class="value">${esc(card.value || "")}</div>
        </div>
      `).join("");

      const texts = project.texts || [];
      const appendix = texts.find((block) => (block.title || "") === "Paper Comparison Appendix (Simple)");
      const appendixEl = document.getElementById("appendix");
      if (appendix) {
        appendixEl.innerHTML = renderBeautifulAppendix(appendix.content || "");
      } else {
        appendixEl.innerHTML = "";
      }

      const links = project.links || [];
      const linksEl = document.getElementById("links");
      if (links.length > 0) {
        linksEl.innerHTML = `
          <h2>Verified Links</h2>
          <div class="card">
            ${
              links.map((link) => `<div><a href="${esc(link.url)}" target="_blank" rel="noopener noreferrer">${esc(link.label || link.url)}</a> <span class="muted">(health: ${esc(link.health || "")}, http: ${esc(link.http_code || "")})</span></div>`).join("")
            }
          </div>
        `;
      } else {
        linksEl.innerHTML = "";
      }

      const tables = project.tables || [];
      document.getElementById("tables").innerHTML = tables.map((t) => (t.paper_table ? renderPaperTable(t) : renderTable(t))).join("");

      document.getElementById("texts").innerHTML = texts
        .filter((block) => (block.title || "") !== "Paper Comparison Appendix (Simple)")
        .map((block) => `
        <div class="section">
          <h2>${esc(block.title || "Text")}</h2>
          <pre>${esc(block.content || "")}</pre>
        </div>
      `)
        .join("");
    }

    function projectById(id) {
      const projects = payload.projects || [];
      return projects.find((p) => p.project_id === id) || projects[0] || null;
    }

    function bindSelect(defaultId) {
      const select = document.getElementById("projectSelect");
      const projects = payload.projects || [];
      const previousValue = select.value || "";
      select.innerHTML = projects.map((p) => `
        <option value="${esc(p.project_id)}">${esc(p.project_name || p.project_id)}</option>
      `).join("");
      const preferred = previousValue || defaultId;
      const exists = projects.some((p) => p.project_id === preferred);
      select.value = exists ? preferred : (projects[0] ? projects[0].project_id : "");
      const current = projectById(select.value);
      if (current) renderProject(current);
      select.onchange = () => {
        const chosen = projectById(select.value);
        if (chosen) renderProject(chosen);
      };
    }

    async function load() {
      const res = await fetch(`${JSON_PATH}?t=${Date.now()}`, { cache: "no-store" });
      payload = await res.json();
      document.getElementById("meta").textContent = `Snapshot generated: ${payload.generated_at_utc || "-"} | Auto-refresh: 15s`;
      bindSelect(payload.default_project_id || "");
    }

    async function tick() {
      try {
        await load();
      } catch (err) {
        document.getElementById("meta").textContent = `Load error: ${err}`;
      }
    }

    tick();
    setInterval(tick, 15000);
  </script>
</body>
</html>
