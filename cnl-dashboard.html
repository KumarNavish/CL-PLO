<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Remote Training Status Dashboard</title>
  <style>
    :root {
      --bg: #f2f8fc;
      --ink: #112538;
      --muted: #516a80;
      --card: #ffffff;
      --line: #d4e1eb;
      --ok: #13652b;
      --warn: #936200;
      --bad: #a71f32;
    }
    body {
      margin: 0;
      background: linear-gradient(160deg, #eaf3fa 0%, #f8fbff 62%);
      color: var(--ink);
      font-family: "Avenir Next", "Segoe UI", sans-serif;
    }
    .wrap {
      max-width: 1160px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 30px;
      letter-spacing: 0.3px;
    }
    .muted {
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 14px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }
    select {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      color: var(--ink);
      min-width: 260px;
      font-size: 14px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      border: 1px solid transparent;
    }
    .status-ok {
      color: var(--ok);
      background: #e6f5ea;
      border-color: #bfe3c8;
    }
    .status-error {
      color: var(--bad);
      background: #fdecef;
      border-color: #f7c9d2;
    }
    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      margin: 12px 0 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(23, 50, 76, 0.07);
    }
    .card .label {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .card .value {
      margin-top: 5px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 14px;
      line-height: 1.35;
    }
    .section {
      margin-bottom: 16px;
    }
    .section h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid var(--line);
      padding: 7px 8px;
      text-align: left;
      font-size: 13px;
      vertical-align: top;
    }
    th {
      background: #e8f1f8;
      font-size: 12px;
      letter-spacing: 0.3px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .status-running { color: var(--warn); font-weight: 700; }
    .status-done { color: var(--ok); font-weight: 700; }
    .status-error { color: var(--bad); font-weight: 700; }
    .status-pending { color: #607689; font-weight: 700; }
    pre {
      margin: 0;
      padding: 12px;
      border-radius: 10px;
      background: #0f172a;
      color: #d9e4f0;
      font-size: 12px;
      line-height: 1.35;
      overflow: auto;
      max-height: 330px;
    }
    a {
      color: #005cc5;
      text-decoration: none;
      font-weight: 700;
    }
    .paper-wrap {
      background: #fff;
      border: 1px solid #cfd7de;
      border-radius: 10px;
      padding: 10px 12px 12px;
      overflow-x: auto;
    }
    .paper-caption {
      margin: 0 0 8px;
      font-family: "Times New Roman", Georgia, serif;
      font-size: 18px;
      line-height: 1.15;
      color: #111;
    }
    .paper-caption .paper-title {
      font-weight: 700;
    }
    .paper-table {
      width: 100%;
      border-collapse: collapse;
      border: none;
      border-radius: 0;
      font-family: "Times New Roman", Georgia, serif;
      background: #fff;
    }
    .paper-table thead tr:first-child th {
      border-top: 2px solid #333;
    }
    .paper-table thead th {
      background: #fff;
      border-bottom: 1px solid #555;
      color: #111;
      font-size: 13px;
      font-variant: small-caps;
      letter-spacing: 0.2px;
      padding: 5px 6px 3px;
      text-align: center;
      white-space: nowrap;
    }
    .paper-table td {
      border-bottom: 1px solid #666;
      color: #111;
      font-size: 14px;
      line-height: 1.02;
      padding: 4px 7px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    .paper-table tbody tr:last-child td {
      border-bottom: 2px solid #333;
    }
    .paper-table .left {
      text-align: left;
    }
    .paper-table .italic {
      font-style: italic;
    }
    .paper-table .sub {
      display: block;
      font-size: 0.92em;
      margin-top: 1px;
    }
    .paper-sep td {
      border-top: 1px solid #555;
    }
    @media (max-width: 800px) {
      .wrap {
        padding: 16px;
      }
      h1 {
        font-size: 24px;
      }
      .paper-caption {
        font-size: 16px;
      }
      .paper-table thead th {
        font-size: 17px;
      }
      .paper-table td {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Remote Training Status Dashboard</h1>
    <p class="muted" id="meta">Loading dashboard snapshot...</p>

    <div class="toolbar">
      <label for="projectSelect"><strong>Project</strong></label>
      <select id="projectSelect"></select>
      <span id="projectStatus" class="badge status-ok">-</span>
    </div>

    <div id="projectError" class="section"></div>
    <div id="cards" class="grid"></div>
    <div id="links" class="section"></div>
    <div id="tables"></div>
    <div id="texts"></div>
  </div>

  <script>
    const JSON_PATH = 'data/run_status.json';
    let payload = null;

    function esc(value) {
      return String(value ?? "").replace(/[&<>]/g, (ch) => {
        if (ch === "&") return "&amp;";
        if (ch === "<") return "&lt;";
        return "&gt;";
      });
    }

    function datasetLabel(dataset) {
      const names = {
        mmlu: "MMLU",
        medqa: "MedQA",
        arc_c: "ARC-C",
        csqa: "CSQA",
      };
      return names[dataset] || dataset || "";
    }

    function splitMainSub(rawValue) {
      const text = String(rawValue ?? "").trim();
      const m = text.match(/^(.+?)\s*\(([^)]*)\)$/);
      if (!m) {
        return { main: text, sub: "" };
      }
      return { main: m[1].trim(), sub: `(${m[2].trim()})` };
    }

    function renderMainSubCell(rawValue) {
      const parts = splitMainSub(rawValue);
      if (!parts.sub) {
        return esc(parts.main);
      }
      return `${esc(parts.main)}<span class="sub">${esc(parts.sub)}</span>`;
    }

    function paperCaption(table) {
      const title = table.title || "Table";
      const caption = table.caption || "";
      if (!caption) {
        return `<p class="paper-caption"><span class="paper-title">${esc(title)}.</span></p>`;
      }
      const prefix = `${title}:`;
      let text = caption;
      if (text.startsWith(prefix)) {
        text = text.slice(prefix.length).trim();
      }
      return `<p class="paper-caption"><span class="paper-title">${esc(prefix)}</span> ${esc(text)}</p>`;
    }

    function renderPaperTable1(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      const row = rows[0] || {};

      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">MODEL</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>DISSIM</th><th>SIM</th>`;
      }
      html += `</tr></thead><tbody><tr>`;
      html += `<td class="left italic">${esc(row.model || table.model || "")}</td>`;
      for (const ds of datasets) {
        html += `<td>${renderMainSubCell(row[`${ds}_dissimilar`])}</td>`;
        html += `<td>${renderMainSubCell(row[`${ds}_similar`])}</td>`;
      }
      html += `</tr></tbody></table></div>`;
      return html;
    }

    function renderPaperTable2(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      const byMetric = {};
      for (const row of rows) {
        byMetric[String(row.metric || "").toUpperCase()] = row;
      }

      const model = table.model || "";
      const prop = byMetric.PROP || {};
      const grad = byMetric.GRAD || {};
      const total = byMetric.TOTAL || {};

      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">MODEL</th>`;
      html += `<th class="left" rowspan="2">METRIC</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>COLL</th><th>CONF</th>`;
      }
      html += `</tr></thead><tbody>`;

      html += `<tr>`;
      html += `<td class="left italic" rowspan="3">${esc(model)}</td>`;
      html += `<td class="left">PROP</td>`;
      for (const ds of datasets) {
        html += `<td>${esc(prop[`${ds}_coll`] || "")}</td>`;
        html += `<td>${esc(prop[`${ds}_conf`] || "")}</td>`;
      }
      html += `</tr>`;

      html += `<tr>`;
      html += `<td class="left">GRAD</td>`;
      for (const ds of datasets) {
        html += `<td>${esc(grad[`${ds}_coll`] || "")}</td>`;
        html += `<td>${esc(grad[`${ds}_conf`] || "")}</td>`;
      }
      html += `</tr>`;

      html += `<tr>`;
      html += `<td class="left">TOTAL</td>`;
      for (const ds of datasets) {
        html += `<td colspan="2">${esc(total[`${ds}_total`] || "")}</td>`;
      }
      html += `</tr>`;

      html += `</tbody></table></div>`;
      return html;
    }

    function renderPaperTable3(table) {
      const datasets = table.dataset_order || [];
      const rows = table.rows || [];
      const orderedRows = [];
      const seen = new Set();
      for (const method of ["FT", "CNL"]) {
        const idx = rows.findIndex((row) => String(row.method || "").toUpperCase() === method);
        if (idx >= 0) {
          orderedRows.push(rows[idx]);
          seen.add(idx);
        }
      }
      rows.forEach((row, idx) => {
        if (!seen.has(idx)) orderedRows.push(row);
      });

      const model = table.model || ((orderedRows[0] || {}).model || "");
      let html = `<div class="section paper-wrap">${paperCaption(table)}`;
      html += `<table class="paper-table"><thead><tr>`;
      html += `<th class="left" rowspan="2">MODEL</th>`;
      html += `<th class="left" rowspan="2">METHOD</th>`;
      for (const ds of datasets) {
        html += `<th colspan="2">${esc(datasetLabel(ds))}</th>`;
      }
      html += `</tr><tr>`;
      for (const _ds of datasets) {
        html += `<th>LEARNED</th><th>FORGOT</th>`;
      }
      html += `</tr></thead><tbody>`;

      orderedRows.forEach((row, idx) => {
        const sepClass = idx > 0 ? " paper-sep" : "";
        html += `<tr class="${sepClass.trim()}">`;
        if (idx === 0) {
          html += `<td class="left italic" rowspan="${orderedRows.length}">${esc(model)}</td>`;
        }
        html += `<td class="left">${esc(row.method || "")}</td>`;
        for (const ds of datasets) {
          html += `<td>${renderMainSubCell(row[`${ds}_learned`])}</td>`;
          html += `<td>${renderMainSubCell(row[`${ds}_forgot`])}</td>`;
        }
        html += `</tr>`;
      });

      html += `</tbody></table></div>`;
      return html;
    }

    function renderPaperTable(table) {
      if (table.paper_table === "table1") {
        return renderPaperTable1(table);
      }
      if (table.paper_table === "table2") {
        return renderPaperTable2(table);
      }
      if (table.paper_table === "table3") {
        return renderPaperTable3(table);
      }
      return renderTable(table);
    }

    function renderTable(table) {
      const cols = table.columns || [];
      const rows = table.rows || [];
      let html = `<div class="section"><h2>${esc(table.title || "Table")}</h2>`;
      html += "<table><tr>";
      for (const c of cols) {
        html += `<th>${esc(c.label || c.key || "")}</th>`;
      }
      html += "</tr>";
      for (const row of rows) {
        html += "<tr>";
        for (const c of cols) {
          const key = c.key || "";
          const value = row[key] ?? "";
          const cls = key === "status" ? `status-${String(value).toLowerCase()}` : "";
          html += `<td class="${esc(cls)}">${esc(value)}</td>`;
        }
        html += "</tr>";
      }
      html += "</table></div>";
      return html;
    }

    function renderProject(project) {
      const statusEl = document.getElementById("projectStatus");
      statusEl.textContent = project.status || "unknown";
      statusEl.className = `badge status-${project.status === "error" ? "error" : "ok"}`;

      const errEl = document.getElementById("projectError");
      if (project.status === "error") {
        errEl.innerHTML = `<div class="card"><strong>Collection Error</strong><div class="value">${esc(project.error || "unknown")}</div></div>`;
      } else {
        errEl.innerHTML = "";
      }

      const cards = project.cards || [];
      document.getElementById("cards").innerHTML = cards.map((card) => `
        <div class="card">
          <div class="label">${esc(card.label || "")}</div>
          <div class="value">${esc(card.value || "")}</div>
        </div>
      `).join("");

      const links = project.links || [];
      const linksEl = document.getElementById("links");
      if (links.length > 0) {
        linksEl.innerHTML = `
          <h2>Verified Links</h2>
          <div class="card">
            ${
              links.map((link) => `<div><a href="${esc(link.url)}" target="_blank" rel="noopener noreferrer">${esc(link.label || link.url)}</a> <span class="muted">(health: ${esc(link.health || "")}, http: ${esc(link.http_code || "")})</span></div>`).join("")
            }
          </div>
        `;
      } else {
        linksEl.innerHTML = "";
      }

      const tables = project.tables || [];
      document.getElementById("tables").innerHTML = tables.map((t) => (t.paper_table ? renderPaperTable(t) : renderTable(t))).join("");

      const texts = project.texts || [];
      document.getElementById("texts").innerHTML = texts.map((block) => `
        <div class="section">
          <h2>${esc(block.title || "Text")}</h2>
          <pre>${esc(block.content || "")}</pre>
        </div>
      `).join("");
    }

    function projectById(id) {
      const projects = payload.projects || [];
      return projects.find((p) => p.project_id === id) || projects[0] || null;
    }

    function bindSelect(defaultId) {
      const select = document.getElementById("projectSelect");
      const projects = payload.projects || [];
      const previousValue = select.value || "";
      select.innerHTML = projects.map((p) => `
        <option value="${esc(p.project_id)}">${esc(p.project_name || p.project_id)}</option>
      `).join("");
      const preferred = previousValue || defaultId;
      const exists = projects.some((p) => p.project_id === preferred);
      select.value = exists ? preferred : (projects[0] ? projects[0].project_id : "");
      const current = projectById(select.value);
      if (current) renderProject(current);
      select.onchange = () => {
        const chosen = projectById(select.value);
        if (chosen) renderProject(chosen);
      };
    }

    async function load() {
      const res = await fetch(`${JSON_PATH}?t=${Date.now()}`, { cache: "no-store" });
      payload = await res.json();
      document.getElementById("meta").textContent = `Snapshot generated: ${payload.generated_at_utc || "-"} | Auto-refresh: 15s`;
      bindSelect(payload.default_project_id || "");
    }

    async function tick() {
      try {
        await load();
      } catch (err) {
        document.getElementById("meta").textContent = `Load error: ${err}`;
      }
    }

    tick();
    setInterval(tick, 15000);
  </script>
</body>
</html>
