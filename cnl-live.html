<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Remote Live Dashboard</title>
  <style>
    :root {
      --ink: #102437;
      --bg: #f1f7fb;
      --card: #ffffff;
      --line: #d5e3ee;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top right, #dbefff 0, #f7fbff 55%, #eef4f9 100%);
      color: var(--ink);
      font-family: "Avenir Next", "Segoe UI", sans-serif;
    }
    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 22px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 8px 20px rgba(23, 50, 76, 0.08);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 26px;
    }
    p {
      margin: 0 0 12px;
      line-height: 1.4;
    }
    a {
      color: #0b5bb5;
      font-weight: 700;
      text-decoration: none;
    }
    iframe {
      width: 100%;
      height: calc(100vh - 240px);
      min-height: 560px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Live Dashboard Bridge</h1>
      <p id="meta">Loading latest verified live link...</p>
      <p id="link_row" style="display:none;">
        <a id="open_link" target="_blank" rel="noopener noreferrer"></a>
      </p>
      <div id="missing_row" style="display:none;">
        No verified public live link is currently available.
      </div>
      <iframe id="live_iframe" title="Live Dashboard" style="display:none;"></iframe>
    </div>
  </div>
  <script>
    const STATUS_JSON = "data/run_status.json";

    function pickProject(payload) {
      const projects = payload.projects || [];
      const defaultId = payload.default_project_id || "";
      return projects.find((p) => p.project_id === defaultId) || projects[0] || null;
    }

    function firstLiveLink(project) {
      const links = project && project.links ? project.links : [];
      for (const link of links) {
        const health = String(link.health || "").toLowerCase();
        if ((health === "healthy" || health === "auth_required") && link.url) {
          return link;
        }
      }
      return null;
    }

    async function load() {
      const res = await fetch(`${STATUS_JSON}?t=${Date.now()}`, { cache: "no-store" });
      const payload = await res.json();
      const project = pickProject(payload);
      const link = firstLiveLink(project);
      const meta = document.getElementById("meta");
      const linkRow = document.getElementById("link_row");
      const missingRow = document.getElementById("missing_row");
      const openLink = document.getElementById("open_link");
      const iframe = document.getElementById("live_iframe");

      if (link) {
        meta.textContent = `Using verified live link (${link.health}, HTTP ${link.http_code || "-"}) | Auto-refresh: 15s`;
        linkRow.style.display = "block";
        missingRow.style.display = "none";
        iframe.style.display = "block";
        openLink.href = link.url;
        openLink.textContent = link.label || link.url;
        iframe.src = link.url;
      } else {
        meta.textContent = "No verified live link found in current snapshot.";
        linkRow.style.display = "none";
        missingRow.style.display = "block";
        iframe.style.display = "none";
      }
    }

    load().catch((err) => {
      document.getElementById("meta").textContent = `Failed to load status: ${err}`;
      document.getElementById("missing_row").style.display = "block";
    });

    setInterval(() => {
      load().catch((err) => {
        document.getElementById("meta").textContent = `Failed to refresh status: ${err}`;
      });
    }, 15000);
  </script>
</body>
</html>
